---
// BusinessStatus.astro - Dynamic business status component
interface Props {
    businessName?: string;
    status?: 'open' | 'closed' | 'unknown';
    hours?: {
        mon?: string;
        tue?: string;
        wed?: string;
        thu?: string;
        fri?: string;
        sat?: string;
        sun?: string;
    };
    permanentlyClosed?: boolean;
}

const { businessName, status, hours, permanentlyClosed } = Astro.props;

// Get current day
const dayNames = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
---

{permanentlyClosed ? (
    <div class="business-status closed-permanently bg-red-100 border-l-4 border-red-500 p-4 my-4">
        <div class="flex items-center">
            <span class="text-2xl mr-2">ğŸš«</span>
            <div>
                <p class="font-bold text-red-700">å·²æ­‡æ¥­</p>
                <p class="text-red-600 text-sm">æ­¤åº—å®¶ç›®å‰å·²ä¸å†ç‡Ÿæ¥­</p>
            </div>
        </div>
    </div>
) : hours ? (
    <div class="business-status bg-gray-50 border border-gray-200 p-4 my-4 rounded" id="business-hours-widget">
        <h4 class="font-bold text-gray-800 mb-2 flex items-center">
            <span class="mr-2">ğŸ•</span>
            {businessName ? `${businessName} ç‡Ÿæ¥­æ™‚é–“` : 'ç‡Ÿæ¥­æ™‚é–“'}
        </h4>
        
        <div class="grid grid-cols-2 gap-1 text-sm mb-3">
            <div class="flex justify-between px-2 py-1 bg-white rounded">
                <span>é€±ä¸€</span>
                <span class="text-gray-600">{hours.mon || 'æœªçŸ¥'}</span>
            </div>
            <div class="flex justify-between px-2 py-1 bg-white rounded">
                <span>é€±äºŒ</span>
                <span class="text-gray-600">{hours.tue || 'æœªçŸ¥'}</span>
            </div>
            <div class="flex justify-between px-2 py-1 bg-white rounded">
                <span>é€±ä¸‰</span>
                <span class="text-gray-600">{hours.wed || 'æœªçŸ¥'}</span>
            </div>
            <div class="flex justify-between px-2 py-1 bg-white rounded">
                <span>é€±å››</span>
                <span class="text-gray-600">{hours.thu || 'æœªçŸ¥'}</span>
            </div>
            <div class="flex justify-between px-2 py-1 bg-white rounded">
                <span>é€±äº”</span>
                <span class="text-gray-600">{hours.fri || 'æœªçŸ¥'}</span>
            </div>
            <div class="flex justify-between px-2 py-1 bg-white rounded">
                <span>é€±å…­</span>
                <span class="text-gray-600">{hours.sat || 'æœªçŸ¥'}</span>
            </div>
            <div class="flex justify-between px-2 py-1 bg-white rounded col-span-2">
                <span>é€±æ—¥</span>
                <span class="text-gray-600">{hours.sun || 'æœªçŸ¥'}</span>
            </div>
        </div>
        
        <!-- Dynamic status badge (updated by JS) -->
        <div id="current-status" class="flex items-center justify-center py-2 rounded font-medium">
            <span class="status-icon mr-2"></span>
            <span class="status-text">æª¢æŸ¥ç‡Ÿæ¥­ç‹€æ…‹ä¸­...</span>
        </div>
    </div>
    
    <script define:vars={{ hours }}>
        function parseTime(timeStr) {
            if (!timeStr || timeStr === 'ä¼‘æ¯' || timeStr === 'å·²æ­‡æ¥­') return null;
            const [h, m] = timeStr.split(':').map(Number);
            return h * 60 + m;
        }
        
        function getBusinessStatus() {
            const now = new Date();
            const dayNames = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
            const day = dayNames[now.getDay()];
            const todayHours = hours[day];
            
            if (!todayHours || todayHours === 'ä¼‘æ¯' || todayHours === 'å…¬ä¼‘') {
                return { status: 'closed-today', message: 'ä»Šæ—¥ä¼‘æ¯', color: 'bg-gray-200 text-gray-700' };
            }
            
            if (todayHours === 'å·²æ­‡æ¥­') {
                return { status: 'permanently-closed', message: 'å·²æ­‡æ¥­', color: 'bg-red-200 text-red-700' };
            }
            
            const parts = todayHours.split('-');
            if (parts.length !== 2) {
                return { status: 'unknown', message: 'ç‡Ÿæ¥­æ™‚é–“æœªçŸ¥', color: 'bg-gray-200 text-gray-600' };
            }
            
            const [openStr, closeStr] = parts;
            const openTime = parseTime(openStr);
            const closeTime = parseTime(closeStr);
            const nowTime = now.getHours() * 60 + now.getMinutes();
            
            if (openTime === null || closeTime === null) {
                return { status: 'unknown', message: 'ç‡Ÿæ¥­æ™‚é–“æ ¼å¼éŒ¯èª¤', color: 'bg-gray-200 text-gray-600' };
            }
            
            if (nowTime >= openTime && nowTime < closeTime) {
                const remaining = closeTime - nowTime;
                const hours = Math.floor(remaining / 60);
                const mins = remaining % 60;
                return { 
                    status: 'open', 
                    message: `ç‡Ÿæ¥­ä¸­ (é‚„æœ‰ ${hours}h ${mins}m æ‰“çƒŠ)`, 
                    color: 'bg-green-200 text-green-700' 
                };
            } else if (nowTime < openTime) {
                const diff = openTime - nowTime;
                const hours = Math.floor(diff / 60);
                const mins = diff % 60;
                return { 
                    status: 'opening-soon', 
                    message: `ä¼‘æ¯ä¸­ (${hours}å°æ™‚${mins}åˆ†å¾Œé–‹é–€)`, 
                    color: 'bg-yellow-200 text-yellow-700' 
                };
            } else {
                return { 
                    status: 'closed', 
                    message: 'ä»Šæ—¥å·²æ‰“çƒŠ', 
                    color: 'bg-gray-200 text-gray-700' 
                };
            }
        }
        
        function updateStatus() {
            const statusEl = document.getElementById('current-status');
            if (!statusEl) return;
            
            const { status, message, color } = getBusinessStatus();
            
            const icon = status === 'open' ? 'ğŸŸ¢' : 
                         status === 'opening-soon' ? 'ğŸŸ¡' : 
                         status === 'permanently-closed' ? 'ğŸš«' : 'ğŸ”´';
            
            statusEl.className = `flex items-center justify-center py-2 rounded font-medium ${color}`;
            statusEl.innerHTML = `<span class="mr-2">${icon}</span><span>${message}</span>`;
        }
        
        // Update immediately
        updateStatus();
        // Update every minute
        setInterval(updateStatus, 60000);
    </script>
) : null}
