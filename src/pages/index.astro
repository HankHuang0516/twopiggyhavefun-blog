---
import Layout from '../layouts/Layout.astro';
import Sidebar from '../components/Sidebar.astro';
import PostCard from '../components/PostCard.astro';
import { getCollection } from 'astro:content';

// Helper to fix image paths
const BASE_URL = '/twopiggyhavefun-blog';
function fixImagePath(src: string | undefined): string {
    if (!src) return `${BASE_URL}/placeholder.jpg`;
    if (src.startsWith('http')) return src;
    if (src.startsWith('/') && !src.startsWith(BASE_URL)) {
        return `${BASE_URL}${src}`;
    }
    return src;
}

// Get all posts
const posts = await getCollection('posts');
// Sort by date desc
posts.sort((a, b) => new Date(b.data.date).valueOf() - new Date(a.data.date).valueOf());

const featuredPosts = posts.slice(0, 5);
const recentPosts = posts.slice(0, 12);
---

<Layout title="é¦–é ">
    <!-- Featured Slider with Fade Effect -->
    <section class="featured-slider relative overflow-hidden bg-black">
        <div class="slider-container relative h-[400px] md:h-[500px]">
            {featuredPosts.map((post, index) => (
                <div class={`slide absolute inset-0 transition-opacity duration-700 ${index === 0 ? 'opacity-100' : 'opacity-0'}`} 
                     data-index={index}>
                    <img 
                        src={fixImagePath(post.data.cover)} 
                        alt={post.data.title}
                        class="w-full h-full object-cover"
                    />
                    <!-- Info overlay at bottom right (like bobowin) -->
                    <div class="absolute bottom-8 right-8 bg-white/90 p-4 max-w-xs hidden md:block">
                        <h3 class="text-sm font-bold text-gray-800 line-clamp-2">
                            {post.data.title}
                        </h3>
                    </div>
                </div>
            ))}
        </div>
        <!-- Slider Navigation Arrows -->
        <button id="prevBtn" class="absolute left-4 top-1/2 -translate-y-1/2 bg-black/30 text-white p-4 hover:bg-black/50 transition text-2xl">
            â€¹
        </button>
        <button id="nextBtn" class="absolute right-4 top-1/2 -translate-y-1/2 bg-black/30 text-white p-4 hover:bg-black/50 transition text-2xl">
            â€º
        </button>
    </section>

    <!-- Main Content: Posts + Sidebar -->
    <div class="container mx-auto px-4 py-8">
        <div class="flex flex-col lg:flex-row gap-8">
            <!-- Main Column: Post List -->
            <div class="flex-1">
                {recentPosts.map((post) => (
                    <PostCard 
                        title={post.data.title}
                        slug={post.slug}
                        date={post.data.date}
                        cover={post.data.cover}
                        tags={post.data.tags}
                    />
                ))}

                {recentPosts.length === 0 && (
                    <div class="text-center py-20 bg-gray-100">
                        <p class="text-xl text-gray-500">æ­£åœ¨åŠªåŠ›æ¬é‹æ–‡ç« ä¸­... ğŸššğŸ’¨</p>
                    </div>
                )}
            </div>

            <!-- Sidebar -->
            <Sidebar />
        </div>
    </div>
</Layout>

<script>
    // Fade Slider Logic
    const slides = document.querySelectorAll('.slide');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    
    let currentIndex = 0;
    const totalSlides = slides.length;

    function goToSlide(index: number) {
        if (totalSlides === 0) return;
        // Hide all slides
        slides.forEach((slide, i) => {
            (slide as HTMLElement).classList.remove('opacity-100');
            (slide as HTMLElement).classList.add('opacity-0');
        });
        // Show target slide
        currentIndex = (index + totalSlides) % totalSlides;
        (slides[currentIndex] as HTMLElement).classList.remove('opacity-0');
        (slides[currentIndex] as HTMLElement).classList.add('opacity-100');
    }

    prevBtn?.addEventListener('click', () => goToSlide(currentIndex - 1));
    nextBtn?.addEventListener('click', () => goToSlide(currentIndex + 1));

    // Auto-slide every 5s with fade
    setInterval(() => goToSlide(currentIndex + 1), 5000);
</script>

<style>
    .featured-slider .slide {
        z-index: 1;
    }
    .featured-slider .slide.opacity-100 {
        z-index: 2;
    }
</style>
