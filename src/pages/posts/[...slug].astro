---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import Sidebar from '../../components/Sidebar.astro';
import BusinessStatus from '../../components/BusinessStatus.astro';
import { getCategorySlug, SIDEBAR_CATEGORIES } from '../../utils/categories';

export async function getStaticPaths() {
  const posts = await getCollection('posts');
  return posts.map(post => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content } = await post.render();
const formattedDate = new Date(post.data.date).toLocaleDateString('zh-TW', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
});

// Share URLs
const currentUrl = `https://hankhuang0516.github.io/twopiggyhavefun-blog/posts/${post.slug}`;
const fbShareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(currentUrl)}`;
const lineShareUrl = `https://social-plugins.line.me/lineit/share?url=${encodeURIComponent(currentUrl)}`;
---

<Layout title={post.data.title}>
    <div class="container mx-auto px-4 py-8">
        <!-- Breadcrumbs -->
        <nav class="text-sm mb-6 text-gray-500">
            <a href="/twopiggyhavefun-blog/" class="hover:text-blue-600">首頁</a>
            <span class="mx-2">›</span>
            {post.data.tags?.[0] && (
                <>
                    <a href={`/twopiggyhavefun-blog/category/${post.data.tags[0]}`} class="hover:text-blue-600">
                        {post.data.tags[0]}
                    </a>
                    <span class="mx-2">›</span>
                </>
            )}
            <span class="text-gray-700">{post.data.title.slice(0, 30)}...</span>
        </nav>

        <div class="flex flex-col lg:flex-row gap-8">
            <!-- Main Article -->
            <article class="flex-1 relative">
                <!-- Floating Share Buttons (Desktop) -->
                <div class="hidden lg:flex flex-col gap-3 fixed left-4 top-1/2 -translate-y-1/2 z-40">
                    <a href={fbShareUrl} target="_blank" rel="noopener noreferrer"
                       class="w-10 h-10 bg-blue-600 text-white flex items-center justify-center rounded hover:bg-blue-700 transition"
                       title="分享到 Facebook">
                        <span class="text-lg">f</span>
                    </a>
                    <a href={lineShareUrl} target="_blank" rel="noopener noreferrer"
                       class="w-10 h-10 bg-green-500 text-white flex items-center justify-center rounded hover:bg-green-600 transition"
                       title="分享到 LINE">
                        <span class="text-lg">L</span>
                    </a>
                </div>

                <!-- Article Header -->
                <header class="mb-8">
                    <h1 class="text-2xl md:text-3xl font-bold text-gray-900 mb-4 leading-tight">
                        {post.data.title}
                    </h1>
                    <div class="flex flex-wrap items-center gap-3 text-sm text-gray-500 mb-4">
                        <span>{formattedDate}</span>
						{post.data.tags && post.data.tags.length > 0 && (
							<>
								<span class="text-gray-300">|</span>
								<svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></svg>
								{post.data.tags.map(tag => (
									<a href={`/twopiggyhavefun-blog/category/${tag}`} class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs hover:bg-gray-200 transition">
										{tag}
									</a>
								))}
							</>
						)}

                    </div>

                    <!-- Business Status -->
                    <BusinessStatus 
                        businessName={post.data.title}
                        rawHours={post.data.businessHours}
                        permanentlyClosed={post.data.isPermanentlyClosed}
                    />

                    {post.data.originalUrl && (
                        <a href={post.data.originalUrl} target="_blank" rel="noopener noreferrer" 
                           class="text-blue-600 text-sm hover:underline">
                            原文連結 (Pixnet) ↗
                        </a>
                    )}
                </header>

                <!-- Featured Image -->
                {post.data.cover && (
                    <div class="mb-8">
                        <img 
                            src={post.data.cover.startsWith('/') && !post.data.cover.startsWith('/twopiggyhavefun-blog') 
                                ? `/twopiggyhavefun-blog${post.data.cover}` 
                                : post.data.cover} 
                            alt={post.data.title}
                            class="w-full h-auto max-h-[500px] object-cover"
                        />
                    </div>
                )}

                <!-- Article Content -->
                <div class="prose prose-lg max-w-none pixnet-content bg-white p-6 md:p-8 border border-gray-200">
                    <Content />
                </div>

                <!-- Personal Category Link -->
                {post.data.category && (
                    <div class="mt-6 p-4 bg-gray-50 border border-gray-200 rounded-lg">
                        <span class="text-gray-600 text-sm">個人分類：</span>
                        <a 
                            href={`/twopiggyhavefun-blog/category/${getCategorySlug(post.data.category)}`}
                            class="text-blue-600 hover:underline font-medium"
                        >
                            {post.data.category}
                        </a>
                    </div>
                )}

                <!-- Mobile Share Buttons -->
                <div class="lg:hidden flex justify-center gap-4 mt-8 py-4 border-t border-gray-200">
                    <a href={fbShareUrl} target="_blank" rel="noopener noreferrer"
                       class="bg-blue-600 text-white px-4 py-2 rounded flex items-center gap-2 hover:bg-blue-700 transition">
                        <span>f</span> 分享 Facebook
                    </a>
                    <a href={lineShareUrl} target="_blank" rel="noopener noreferrer"
                       class="bg-green-500 text-white px-4 py-2 rounded flex items-center gap-2 hover:bg-green-600 transition">
                        <span>L</span> 分享 LINE
                    </a>
                </div>
            </article>

            <!-- Sidebar -->
            <Sidebar />
        </div>
    </div>
</Layout>

<style is:global>
    /* Pixnet Content Overrides */
    .pixnet-content img {
        margin: 1.5em auto;
        max-width: 100%;
        height: auto;
    }
    .pixnet-content iframe {
        max-width: 100%;
        margin: 1.5em auto;
    }
    .pixnet-content p {
        margin-bottom: 1.5em;
        line-height: 1.8;
    }
    .pixnet-content ul { list-style-type: disc; padding-left: 1.5em; }
    .pixnet-content ol { list-style-type: decimal; padding-left: 1.5em; }
    .pixnet-content a {
        color: #337ab7;
    }
    .pixnet-content a:hover {
        text-decoration: underline;
    }
</style>

<script>
    // Fix content images client-side to handle base URL
    document.addEventListener('DOMContentLoaded', () => {
        const baseUrl = '/twopiggyhavefun-blog';
        const contentImages = document.querySelectorAll('.pixnet-content img');
        
        contentImages.forEach(img => {
            const src = img.getAttribute('src');
            if (src && src.startsWith('/') && !src.startsWith(baseUrl)) {
                img.src = `${baseUrl}${src}`;
            }
        });
    });
</script>
