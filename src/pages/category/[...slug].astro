---
import Layout from '../../layouts/Layout.astro';
import Sidebar from '../../components/Sidebar.astro';
import { getCollection } from 'astro:content';
import { 
    categorizePost, 
    isForeignTravel, 
    isParenting, 
    isUnboxing, 
    isWedding, 
    regionNames,
    regionKeywords,
    PIXNET_CATEGORY_HIERARCHY
} from '../../utils/categories';

export async function getStaticPaths() {
    const allPosts = (await getCollection('posts')).filter(p => p.data);
    const slugs = new Set<string>();
    
    // 1. Add main category slugs
    for (const config of Object.values(PIXNET_CATEGORY_HIERARCHY)) {
        slugs.add(config.slug);
    }
    
    // 2. Add all subcategory names from hierarchy (Chinese names)
    for (const config of Object.values(PIXNET_CATEGORY_HIERARCHY)) {
        for (const sub of config.subcategories) {
            slugs.add(sub); // e.g., "å°åŒ—ç¾é£Ÿ", "å®œè˜­æ™¯é»"
        }
    }
    
    // 3. Add all unique category values from posts
    allPosts.forEach(post => {
        if (post.data.category) {
            slugs.add(post.data.category);
        }
    });

    // 4. Add dynamic region-type subcategories (legacy support)
    allPosts.forEach(post => {
        const title = post.data.title || '';
        const tags = post.data.tags || [];
        const { contentType, region } = categorizePost(title, tags);
        if (contentType && region) {
            slugs.add(`${region}-${contentType}`);
        }
    });

    return Array.from(slugs).map(slug => ({
        params: { slug },
        props: { slug }
    }));
}

const { slug } = Astro.props;
const allPosts = (await getCollection('posts')).filter(p => p.data);
allPosts.sort((a, b) => {
    if (!a.data?.date || !b.data?.date) return 0;
    return new Date(b.data.date).valueOf() - new Date(a.data.date).valueOf();
});

// Filter logic
let categoryTitle = '';
let filteredPosts: typeof allPosts = [];

const [part1, part2] = slug.split('-');

// 1. Check Special Categories
if (slug === 'foreign-travel') {
    categoryTitle = 'åœ‹å¤–æ—…éŠ';
    filteredPosts = allPosts.filter(post => isForeignTravel(post.data.title || ''));
} else if (slug === 'parenting') {
    categoryTitle = 'è¦ªå­è‚²å…’';
    filteredPosts = allPosts.filter(post => isParenting(post.data.title || ''));
} else if (slug === 'unboxing') {
    categoryTitle = 'é–‹ç®±æ¨è–¦';
    filteredPosts = allPosts.filter(post => isUnboxing(post.data.title || ''));
} else if (slug === 'wedding') {
    categoryTitle = 'å©šç¦®å¤§å°äº‹';
    filteredPosts = allPosts.filter(post => isWedding(post.data.title || ''));
} else if (slug === 'other') {
    categoryTitle = 'å…¶ä»–';
    filteredPosts = allPosts.filter(post => {
        const title = post.data.title || '';
        const tags = post.data.tags || [];
        const { contentType, region } = categorizePost(title, tags);
        if (isForeignTravel(title) || isParenting(title) || isUnboxing(title) || isWedding(title)) return false;
        if ((contentType === 'food' || contentType === 'travel' || contentType === 'hotel') && region) return false;
        // Check fallback logic matches Sidebar's "other"
        if (contentType === 'food' || contentType === 'travel') return false; 
        return true;
    });
} 
// 2. Check Domestic Main Categories
else if (slug === 'domestic-food') {
    categoryTitle = 'åœ‹å…§ç¾é£Ÿ';
    filteredPosts = allPosts.filter(post => {
        const title = post.data.title || '';
        const tags = post.data.tags || [];
        const { contentType, region } = categorizePost(title, tags);
        return contentType === 'food' && (region || true); // Include fallback "food" in domestic main?
        // Sidebar logic: domesticFood includes categorized by region + fallback 'other' region food
        // So yes, all food that isn't Foreign.
        // But categorizePost separates based on keywords. 
        // Sidebar logic: if contentType === 'food', it counts towards domesticFood.
    });
} else if (slug === 'domestic-travel') {
    categoryTitle = 'åœ‹å…§æ—…éŠ';
    filteredPosts = allPosts.filter(post => {
        const title = post.data.title || '';
        const tags = post.data.tags || [];
        const { contentType } = categorizePost(title, tags);
        return contentType === 'travel';
    });
} else if (slug === 'domestic-hotel') {
    categoryTitle = 'åœ‹å…§ä½å®¿';
    filteredPosts = allPosts.filter(post => {
        const title = post.data.title || '';
        const tags = post.data.tags || [];
        const { contentType } = categorizePost(title, tags);
        return contentType === 'hotel';
    });
}
// 3. Subcategories (e.g. taipei-food)
else if (part2 && (part2 === 'food' || part2 === 'travel' || part2 === 'hotel')) {
    const regionKey = part1;
    const typeKey = part2;
    const regionName = regionNames[regionKey] || regionKey;
    
    if (typeKey === 'food') categoryTitle = `${regionName}ç¾é£Ÿ`;
    if (typeKey === 'travel') categoryTitle = `${regionName}æ™¯é»`;
    if (typeKey === 'hotel') categoryTitle = `${regionName}ä½å®¿`;

    filteredPosts = allPosts.filter(post => {
        const title = post.data.title || '';
        const tags = post.data.tags || [];
        const { contentType, region } = categorizePost(title, tags);
        return contentType === typeKey && region === regionKey;
    });
}
// 4. Chinese subcategory names (e.g., "å°åŒ—ç¾é£Ÿ", "ä¿å¥é£Ÿå“", "å®œè˜­æ™¯é»")
// Filter by exact category match in frontmatter
else {
    categoryTitle = slug; // Use the Chinese name directly as title
    filteredPosts = allPosts.filter(post => post.data.category === slug);
}

// Pagination or just show all? 
// For now, simple list.
const BASE_URL = '/twopiggyhavefun-blog';

function fixImagePath(src: string | undefined): string {
    if (!src) return `${BASE_URL}/placeholder.jpg`;
    if (src.startsWith('http')) return src;
    if (src.startsWith('/') && !src.startsWith(BASE_URL)) {
        return `${BASE_URL}${src}`;
    }
    return src;
}
---

<Layout title={`${categoryTitle} - å…©éš»å°è±¬`}>
    <main class="container mx-auto max-w-7xl p-4 flex flex-col lg:flex-row gap-8">
        <!-- Content Area -->
        <div class="flex-1">
            <header class="mb-8 border-b border-gray-200 pb-4">
                <h1 class="text-3xl font-bold text-gray-800 flex items-center gap-2">
                    <span class="text-blue-600">ğŸ“‚</span> {categoryTitle}
                </h1>
                <p class="text-gray-500 mt-2">å…± {filteredPosts.length} ç¯‡æ–‡ç« </p>
            </header>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                {filteredPosts.map((post) => (
                    <article class="bg-white border border-gray-200 rounded-lg shadow-sm hover:shadow-md transition overflow-hidden">
                        <a href={`${BASE_URL}/posts/${post.slug}`} class="block h-full">
                            <div class="aspect-w-16 aspect-h-9 bg-gray-100 relative h-48">
                                <img 
                                    src={fixImagePath(post.data.cover)} 
                                    alt={post.data.title}
                                    class="w-full h-full object-cover transition duration-300 hover:scale-105"
                                    loading="lazy"
                                />
                            </div>
                            <div class="p-4">
                                <h2 class="text-lg font-bold text-gray-800 mb-2 line-clamp-2 hover:text-blue-600">
                                    {post.data.title}
                                </h2>
                                <div class="flex flex-wrap gap-2 text-xs text-gray-500 mb-3">
                                    <span>ğŸ“… {new Date(post.data.date).toLocaleDateString('zh-TW')}</span>
                                    {post.data.tags && post.data.tags.slice(0, 3).map((tag: string) => (
                                        <span class="bg-gray-100 px-2 py-0.5 rounded">{tag}</span>
                                    ))}
                                </div>
                            </div>
                        </a>
                    </article>
                ))}
            </div>

            {filteredPosts.length === 0 && (
                <div class="text-center py-20 text-gray-500">
                    <p class="text-xl">æ­¤åˆ†é¡ç›®å‰æ²’æœ‰æ–‡ç« ã€‚</p>
                    <a href={BASE_URL} class="text-blue-500 hover:underline mt-4 inline-block">è¿”å›é¦–é </a>
                </div>
            )}
        </div>

        <!-- Sidebar -->
        <Sidebar />
    </main>
</Layout>
